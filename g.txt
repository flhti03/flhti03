import sqlite3
import logging
import asyncio
from aiogram import Bot, Dispatcher, types
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
from aiogram.utils import executor
from datetime import datetime, timedelta

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª
TOKEN = "7767135522:AAFVIFSKqH0CdS8ncyJN7j3m0wsXl8Z68ks"  # ØªÙˆÚ©Ù† Ø±Ø¨Ø§ØªØª Ø±Ùˆ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø°Ø§Ø±
FORWARD_CHAT_ID = -6679744892  # Ø¢ÛŒØ¯ÛŒ Ú†Øª Ù…Ù‚ØµØ¯

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù„Ø§Ú¯
logging.basicConfig(level=logging.INFO)

# Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø±Ø¨Ø§Øª
bot = Bot(token=TOKEN)
dp = Dispatcher(bot)

# Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
conn = sqlite3.connect("users.db")
cursor = conn.cursor()
cursor.execute("""
    CREATE TABLE IF NOT EXISTS users (
        user_id INTEGER PRIMARY KEY,
        expires_at TEXT
    )
""")
conn.commit()

# Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ú©ÛŒØ¨ÙˆØ±Ø¯
keyboard = ReplyKeyboardMarkup(resize_keyboard=True)
keyboard.add(KeyboardButton("ğŸ”„ ØªÙ…Ø¯ÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú©"))

# Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø§Ø´ØªØ±Ø§Ú©
def check_subscription(user_id):
    cursor.execute("SELECT expires_at FROM users WHERE user_id=?", (user_id,))
    result = cursor.fetchone()
    if result:
        expires_at = datetime.strptime(result[0], "%Y-%m-%d %H:%M:%S")
        return expires_at > datetime.now()
    return False

# Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø§ Ø§Ø´ØªØ±Ø§Ú© Ø³Ù‡â€ŒØ±ÙˆØ²Ù‡ Ø±Ø§ÛŒÚ¯Ø§Ù†
@dp.message_handler(commands=["start"])
async def start(message: types.Message):
    user_id = message.from_user.id
    if not check_subscription(user_id):
        expires_at = datetime.now() + timedelta(days=3)
        cursor.execute("INSERT OR REPLACE INTO users (user_id, expires_at) VALUES (?, ?)", (user_id, expires_at.strftime("%Y-%m-%d %H:%M:%S")))
        conn.commit()
        await message.answer("âœ… Ø§Ø´ØªØ±Ø§Ú© Û³ Ø±ÙˆØ²Ù‡ Ø±Ø§ÛŒÚ¯Ø§Ù† Ø´Ù…Ø§ ÙØ¹Ø§Ù„ Ø´Ø¯!", reply_markup=keyboard)
    else:
        await message.answer("âœ… Ø´Ù…Ø§ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ø§Ø´ØªØ±Ø§Ú© ÙØ¹Ø§Ù„ Ø¯Ø§Ø±ÛŒØ¯.", reply_markup=keyboard)

# Ø¯Ø±ÛŒØ§ÙØª Ùˆ ÙÙˆØ±ÙˆØ§Ø±Ø¯ Ù¾ÛŒØ§Ù…
@dp.message_handler(content_types=types.ContentTypes.ANY)
async def forward_message(message: types.Message):
    user_id = message.from_user.id
    if check_subscription(user_id):
        await bot.forward_message(FORWARD_CHAT_ID, message.chat.id, message.message_id)
    else:
        await message.answer("âŒ Ø§Ø´ØªØ±Ø§Ú© Ø´Ù…Ø§ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø§Ø´ØªØ±Ø§Ú© Ø®ÙˆØ¯ Ø±Ø§ ØªÙ…Ø¯ÛŒØ¯ Ú©Ù†ÛŒØ¯.")

# Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª
if name == "main":
    executor.start_polling(dp, skip_updates=True)